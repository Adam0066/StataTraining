------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Tim\Documents\Github\StataTraining\Day2\MessyDataExamples.log
  log type:  text
 opened on:   4 Jan 2016, 13:11:26

. 
. cd "$pathdata"
C:\Users\Tim\Documents\Github\StataTraining\Day2\Data

. 
. * ### Column headers are numbers, not names ###
. clear all

. input str19 agency _1st _2nd _3rd _4th

                  agency       _1st       _2nd       _3rd       _4th
  1. "DOS"   4       4       4       4
  2. "MCC" 36        29      41      35
  3. "Peace Corps"   73      8       0       0
  4. "USAID" 428     559 429 667
  5. "USDA" 1        0       1       0
  6. end

. 
. saveold "column_numbers.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file column_numbers.dta saved

. 
. * How easily can I summarize this data?
. 
. * Rename the variables to real names
. rename (_1st _2nd _3rd _4th) (qtr1 qtr2 qtr3 qtr4)

. 
. * Melt the data so that each row is an entry for each agency, by quarter
. reshape long qtr, i(agency) j(quarter)
(note: j = 1 2 3 4)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        5   ->      20
Number of variables                   5   ->       3
j variable (4 values)                     ->   quarter
xij variables:
                     qtr1 qtr2 ... qtr4   ->   qtr
-----------------------------------------------------------------------------

. rename qtr freq

. 
. * Free axis versus fixed. 
. graph bar (mean) freq, over(quarter) by(agency, style(compact) rows(1)) scheme(s1color)

. graph bar (mean) freq, over(quarter) by(agency, yrescale style(compact) rows(1))

. 
. 
. 
. * ------------------------------------------------- *
. * ### Multiple variables are stored in 1 column ###
. clear all

. input str3 country str5 agency q1FY2009 q2FY2009 q3FY2009 q4FY2009 q1FY2010 q2FY2010 q3FY2010 q4FY2010

       country     agency   q1FY2009   q2FY2009   q3FY2009   q4FY2009   q1FY2010   q2FY2010   q3FY2010   q4FY2010
  1. "AFG"   "USAID" 399     361     254     71      378     398     85      39
  2. "ALB"   "USAID" 45      282     40      285     306     230     398     216
  3. "ANG"   "USAID" 354     24      19      252     146     123     369     376
  4. "ARM"   "USAID" 86      89      127     212     394     255     141     74
  5. "AZE"   "USAID" 116     239     330     34      92      315     312     220
  6. end

. saveold "mVars_column.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file mVars_column.dta saved

. 
. * Melt data based on the time variable, country is the unique identifier
. reshape long q@, i(country) j(time, string)
(note: j = 1FY2009 1FY2010 2FY2009 2FY2010 3FY2009 3FY2010 4FY2009 4FY2010)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        5   ->      40
Number of variables                  10   ->       4
j variable (8 values)                     ->   time
xij variables:
         q1FY2009 q1FY2010 ... q4FY2010   ->   q
-----------------------------------------------------------------------------

. 
. * Grab the 1st value of each observations in the time variable
. generate qtr = real(substr(time, 1, 1))

. 
. * Create a time variable using a similar approach. The real() function returns 
. * a numeric when a number is coded as a string. Returns missing if no numbers are found.
. generate year = real(substr(time, 4, 7))

. sort country  year qtr

. order country agency qtr year q

. 
. * --- Alternative method: using reshape twice --- *
. clear all

. input str3 country str5 agency q1FY2009 q2FY2009 q3FY2009 q4FY2009 q1FY2010 q2FY2010 q3FY2010 q4FY2010

       country     agency   q1FY2009   q2FY2009   q3FY2009   q4FY2009   q1FY2010   q2FY2010   q3FY2010   q4FY2010
  1. "AFG"   "USAID" 399     361     254     71      378     398     85      39
  2. "ALB"   "USAID" 45      282     40      285     306     230     398     216
  3. "ANG"   "USAID" 354     24      19      252     146     123     369     376
  4. "ARM"   "USAID" 86      89      127     212     394     255     141     74
  5. "AZE"   "USAID" 116     239     330     34      92      315     312     220
  6. end

. 
. * First, reshape based on the year values
. reshape long q1FY@ q2FY@ q3FY@ q4FY@, i(country) j(year)
(note: j = 2009 2010)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        5   ->      10
Number of variables                  10   ->       7
j variable (2 values)                     ->   year
xij variables:
                      q1FY2009 q1FY2010   ->   q1FY
                      q2FY2009 q2FY2010   ->   q2FY
                      q3FY2009 q3FY2010   ->   q3FY
                      q4FY2009 q4FY2010   ->   q4FY
-----------------------------------------------------------------------------

. sort country year

. 
. * Remove the FY part from each variables
. rename *FY *

. 
. * Reshape again, based on the qtr values
. reshape long q@, i(country year) j(qtr)
(note: j = 1 2 3 4)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                       10   ->      40
Number of variables                   7   ->       5
j variable (4 values)                     ->   qtr
xij variables:
                           q1 q2 ... q4   ->   q
-----------------------------------------------------------------------------

. rename q freq 

. 
. 
. 
. * ------------------------------------------------- *
. * ### Variables stored in both rows and columns ### *
. * More complicated example using mutiple reshapes
. clear all

. input str6 stringid     str6 good year2011 year2012

      stringid       good   year2011   year2012
  1. "Malawi" "coffee"       5.93    2.40
  2. "Malawi" "maize"        1.23    0.56
  3. "Uganda" "coffee"       3.09    4.26
  4. "Uganda" "maize"        9.17    7.51
  5. "Rwanda" "coffee"       7.35    3.23
  6. "Rwanda" "maize"        4.78    6.46
  7. end

. saveold "vars_row_columns.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file vars_row_columns.dta saved

. 
. * Goal: Transform data so each good is organized as a panel, by country
. * Country will be the unique identifier, and the suffix of the year variable is 
. * the name of each good.
. reshape wide year*, i(stringid) j(good, string)
(note: j = coffee maize)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                        6   ->       3
Number of variables                   4   ->       5
j variable (2 values)              good   ->   (dropped)
xij variables:
                               year2011   ->   year2011coffee year2011maize
                               year2012   ->   year2012coffee year2012maize
-----------------------------------------------------------------------------

. 
. * Why doesn't the following work? 
. cap reshape long year2011coffee year2012coffee year2011maize year2012maize, i(stringid) j(year)

. 
. * Stata is looking for a variable named _gooda#_ _goodb#_
. * What we provided is not sufficient for the function. Let's rename our variables and try again
. rename (year2011coffee year2012coffee year2011maize year2012maize) /*
> */ (coffee2011 coffee2012 maize2011 maize2012)

. 
. /* If you have numerous variables a general solution maybe more appropriate, such as:
> foreach x of varlist year* {
>         local n1: variable label `x'
>         local n2 = strtoname("`n1'")
>         rename `x' `n2'
>         }
> *end
> rename *_year* **
> */
. reshape long coffee@ maize@, i(stringid) j(year)
(note: j = 2011 2012)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        3   ->       6
Number of variables                   5   ->       4
j variable (2 values)                     ->   year
xij variables:
                  coffee2011 coffee2012   ->   coffee
                    maize2011 maize2012   ->   maize
-----------------------------------------------------------------------------

. list, clean noo

    stringid   year   coffee   maize  
      Malawi   2011     5.93    1.23  
      Malawi   2012      2.4     .56  
      Rwanda   2011     7.35    4.78  
      Rwanda   2012     3.23    6.46  
      Uganda   2011     3.09    9.17  
      Uganda   2012     4.26    7.51  

. 
. 
. * ------------------------------------------------- *
. * ### Reshape examples ###
. clear

. input id gdp2014 gdp2015 cpc2014 cpc2015

            id    gdp2014    gdp2015    cpc2014    cpc2015
  1. 1 8.28 9.99 1 1
  2. 2 9.10 4.05 0 0
  3. end

. saveold "gdp_cpd.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file gdp_cpd.dta saved

. 
. clist, noo

       id    gdp2014    gdp2015    cpc2014    cpc2015
        1       8.28       9.99          1          1
        2        9.1       4.05          0          0

. * Looks as if a variable (year) is stored in the name
. * Try to (melt) reshape the data from wide to long 
. reshape long gdp@ cpc@, i(id) j(year)
(note: j = 2014 2015)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        2   ->       4
Number of variables                   5   ->       4
j variable (2 values)                     ->   year
xij variables:
                        gdp2014 gdp2015   ->   gdp
                        cpc2014 cpc2015   ->   cpc
-----------------------------------------------------------------------------

. 
. * Revert back to original data
. reshape wide
(note: j = 2014 2015)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                        4   ->       2
Number of variables                   4   ->       5
j variable (2 values)              year   ->   (dropped)
xij variables:
                                    gdp   ->   gdp2014 gdp2015
                                    cpc   ->   cpc2014 cpc2015
-----------------------------------------------------------------------------

. 
. 
. 
. * ------------------------------------------------- *
. * ### Reshape Exercise  & Solution ###
. use "wb_gdp_wide.dta", clear

. 
. /* How are data messy?
> 1) Columns contain variables
> 2) Series name is unclear
> */
. 
. * Make the data tidy by using the reshape command.
. reshape long yr@, i(countryname) j(year)
(note: j = 2009 2010 2011 2012)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        5   ->      20
Number of variables                   8   ->       6
j variable (4 values)                     ->   year
xij variables:
               yr2009 yr2010 ... yr2012   ->   yr
-----------------------------------------------------------------------------

. 
. * Once reshaped, rename and label key variables. Drop uncessary variables.
. rename (countryname countrycode yr) (country ISO3 gdp)

. drop seriesname seriescode

. 
. * Which country grew the most from 2009-2012
. * Visual answer
. twoway(connected gdp year), by(country) scheme(s1color)

. 
. *Tabular answer
. table country year, c(mean gdp) f(%9.2f) col

-----------------------------------------------
            |               year               
    country |  2009   2010   2011   2012  Total
------------+----------------------------------
Afghanistan | 21.02   8.43   6.11  14.43  12.50
    Georgia | -3.78   6.25   7.20   6.18   3.96
      Kenya |  3.31   8.40   6.11   4.55   5.59
   Pakistan |  2.83   1.61   2.75   3.51   2.67
    Senegal |  2.42   4.18   1.76   4.36   3.18
-----------------------------------------------

. 
. *egen way to create a variable of average growth
. egen gdp_ave = mean(gdp), by(country)

. tab country, sum(gdp_ave)

            |         Summary of gdp_ave
    country |        Mean   Std. Dev.       Freq.
------------+------------------------------------
Afghanistan |   12.500591           0           4
    Georgia |   3.9648423           0           4
      Kenya |    5.593936           0           4
   Pakistan |   2.6734469           0           4
    Senegal |   3.1817145           0           4
------------+------------------------------------
      Total |   5.5829062    3.690765          20

. 
. * -------------------------------------------------- *
. * ### Merging Examples ###
. clear

. input id age hid

            id        age        hid
  1. 1 45 101
  2. 2 20 101
  3. 1 23 102
  4. 2 20 102
  5. end

. saveold "ind.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file ind.dta saved

. 
. clear

. input id cows value

            id       cows      value
  1. 1 2 2000
  2. 2 1 500
  3. end

. saveold "ind_ag.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file ind_ag.dta saved

. 
. clear

. input hid str4 income

           hid     income
  1. 101 "$100"
  2. 102 "$250"
  3. end

. saveold "hh.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file hh.dta saved

. 
. clear

. input hid str4 income

           hid     income
  1. 101 "$100"
  2. 102 "$250"
  3. 104 "$500"
  4. end

. saveold "hh2.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file hh2.dta saved

. 
. clear

. input id age hid

            id        age        hid
  1. 1 45 101
  2. 2 20 101
  3. 1 23 102
  4. 2 20 102
  5. 1 43 103
  6. 2 5  103
  7. end

. saveold "ind2.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file ind2.dta saved

. 
. * Messy data for merge exercise
. clear

. input hid str4 income

           hid     income
  1. 101 "$100"
  2. 101 "$100"
  3. 102 "$250"
  4. 104 "$500"
  5. 104 ""
  6. end

. saveold "hh3.dta", replace version(12)
(saving in Stata 12 format, which can be read by Stata 11 or 12)
file hh3.dta saved

. 
. 
. 
end of do-file

